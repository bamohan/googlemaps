<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Use external APIs to finish project 9">
    <meta name="author" content="BM">
    <title> Project 9 - Google maps </title>
    <link rel="stylesheet" type="text/css" href="css/style.css">
     <script src="js/lib/knockout-3.4.0.js"></script>
    <script type="text/javascript" src="js/app.js" ></script>
  </head>

  <body>
    <ul id="location-list"></ul>
    <div id="map"></div>

    <script>
      var model = {
       currentLocation: null,
       locations: [{
         title: 'TJs',
         location: {
           lat: 37.311798,
           lng: -122.030951
         }
       }, {
         title: 'Krung Thai',
         location: {
           lat: 37.327528,
           lng: -121.949867
         }
       }, {
         title: 'Cupertino High',
         location: {
           lat: 37.319433,
           lng: -122.009124
         }
       }, {
         title: 'Library',
         location: {
           lat: 37.317851,
           lng: -122.028755
         }
       }, {
         title: 'Starbucks',
         location: {
           lat: 37.321950,
           lng: -122.032856
         }
       }]
      };

      var locationListView = {
        init: function() {
          this.locationListElem = document.getElementById('location-list');
          this.render();
        },

        render: function() {
          var location, elem, i;
          var locations = viewModel.getLocations();
          this.locationListElem.innerHTML = '';

          for (i = 0; i < locations.length; i++) {
            location = locations[i];

            elem = document.createElement('li');
            elem.textContent = location.title;
            elem.addEventListener('click', (function(locationCopy) {
              return function() {
                viewModel.setCurrentLocation(locationCopy);
                //catView.render();
              };
            })(location));
            this.locationListElem.appendChild(elem);
          }
        }
      };

      var viewModel = {

       init: function() {
         model.currentLocation = model.locations[0];
         locationListView.init();
       },

       getCurrentLocation: function() {
         return model.currentLocation;
       },

       getLocations: function() {
         return model.locations;
       },

       setCurrentLocation: function(location) {
         console.log("current Location was set to " + location);
         model.currentLocation = location;
       }
      };

      //ko.applyBindings(new ViewModel());
      viewModel.init();

      var map;
      var markers = [];

      function initMap() {
        var firstOne = viewModel.getCurrentLocation().location;
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: firstOne.lat, lng: firstOne.lng},
          zoom: 13
        });

        var largeInfowindow = new google.maps.InfoWindow();
        var bounds = new google.maps.LatLngBounds();

        // The following group uses the location array to create an array of markers on initialize.
        var locations = viewModel.getLocations();
        for (var i = 0; i < locations.length; i++) {
          var position = locations[i].location;
          var title = locations[i].title;

          // Create a marker per location, and put into markers array.
          var marker = new google.maps.Marker({
            map: map,
            position: position,
            title: title,
            animation: google.maps.Animation.DROP,
            id: i
          });
          markers.push(marker);

          // Create an onclick event to open an infowindow at each marker.
          marker.addListener('click', function() {
            populateInfoWindow(this, largeInfowindow);
          });
          bounds.extend(markers[i].position);
        }
        map.fitBounds(bounds);
      }

      // This function populates the infowindow when the marker is clicked. We'll only allow
      // one infowindow which will open at the marker that is clicked, and populate based
      // on that markers position.
      function populateInfoWindow(marker, infowindow) {
        // Check to make sure the infowindow is not already opened on this marker.
        if (infowindow.marker != marker) {
          infowindow.marker = marker;
          infowindow.setContent('<div>' + marker.title + '</div>');
          infowindow.open(map, marker);
          // Make sure the marker property is cleared if the infowindow is closed.
          infowindow.addListener('closeclick',function(){
            infowindow.setMarker(null);
          });
        }
      }

    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDJc2HmAHWCveDSrOumQXmYYebyePzL5HM&v=3&callback=initMap">
    </script>

  </body>
</html>
